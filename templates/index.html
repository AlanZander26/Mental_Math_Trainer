<!DOCTYPE html>
<html>
<head>
    <title>Mental Math Test</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 700px;
            margin: auto;
        }
        input, select {
            margin: 5px 0;
            padding: 5px;
        }
        .question {
            margin: 20px 0;
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }
        .hidden {
            display: none;
        }
        label {
            display: inline-block;
            width: 30px;
        }
        .range-group {
            margin-bottom: 10px;
        }
        .op-symbol {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0 10px;
            display: inline-block;
            width: 20px;
            text-align: center;
        }
        .question-label {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 6px;
        }
        .question-expression {
            font-size: 1.7em;
            margin-bottom: 10px;
        }
        .answer-box {
            font-size: 1.2em;
            width: 120px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>ðŸ§  Mental Math Trainer</h1>

    <h2>Test Settings</h2>
    <form id="settingsForm">
        <div>
            <label>Questions:</label><br>
            <input type="number" id="numQuestions" value="5" min="1" max="100" style="width: 80px;">
        </div>

        <div>
            <strong>Choose Operations:</strong><br>
            <label><input type="checkbox" value="+" checked> +</label>
            <label><input type="checkbox" value="-" checked> âˆ’</label>
            <label><input type="checkbox" value="*" checked> Ã—</label>
            <label><input type="checkbox" value="/" checked> Ã·</label>
        </div>

        <div id="operationRanges">
            <p><strong>Operand Ranges by Operation:</strong></p>

            <div class="range-group">
                <input type="number" id="plus_r1_min" value="1" style="width: 60px;"> to
                <input type="number" id="plus_r1_max" value="10" style="width: 60px;">
                <span class="op-symbol">+</span>
                <input type="number" id="plus_r2_min" value="1" style="width: 60px;"> to
                <input type="number" id="plus_r2_max" value="10" style="width: 60px;">
            </div>

            <div class="range-group">
                <input type="number" id="minus_r1_min" value="10" style="width: 60px;"> to
                <input type="number" id="minus_r1_max" value="50" style="width: 60px;">
                <span class="op-symbol">âˆ’</span>
                <input type="number" id="minus_r2_min" value="1" style="width: 60px;"> to
                <input type="number" id="minus_r2_max" value="25" style="width: 60px;">
            </div>

            <div class="range-group">
                <input type="number" id="mult_r1_min" value="2" style="width: 60px;"> to
                <input type="number" id="mult_r1_max" value="9" style="width: 60px;">
                <span class="op-symbol">Ã—</span>
                <input type="number" id="mult_r2_min" value="2" style="width: 60px;"> to
                <input type="number" id="mult_r2_max" value="9" style="width: 60px;">
            </div>

            <div class="range-group">
                <input type="number" id="div_r1_min" value="2" style="width: 60px;"> to
                <input type="number" id="div_r1_max" value="100" style="width: 60px;">
                <span class="op-symbol">Ã·</span>
                <input type="number" id="div_r2_min" value="1" style="width: 60px;"> to
                <input type="number" id="div_r2_max" value="10" style="width: 60px;">
            </div>
        </div>

        <button type="submit">Generate Test</button>
    </form>

    <div id="testContainer" class="hidden">
        <h2>Answer the Questions</h2>
        <form id="answerForm">
            <div id="questionList"></div>
            <button type="submit">Submit Answers</button>
        </form>
    </div>

    <div id="results" class="hidden"></div>

    <script>
        const settingsForm = document.getElementById("settingsForm");
        const testContainer = document.getElementById("testContainer");
        const questionList = document.getElementById("questionList");
        const answerForm = document.getElementById("answerForm");
        const resultsDiv = document.getElementById("results");

        let currentQuestions = [];

        settingsForm.addEventListener("submit", async function(event) {
            event.preventDefault();

            const number_questions = parseInt(document.getElementById("numQuestions").value);
            const operations = Array.from(settingsForm.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);

            const opMap = {
                "+": "plus",
                "-": "minus",
                "*": "mult",
                "/": "div"
            };

            const ranges_by_op = {};
            operations.forEach(op => {
                const prefix = opMap[op];

                const r1_min = parseInt(document.getElementById(`${prefix}_r1_min`).value);
                const r1_max = parseInt(document.getElementById(`${prefix}_r1_max`).value);
                const r2_min = parseInt(document.getElementById(`${prefix}_r2_min`).value);
                const r2_max = parseInt(document.getElementById(`${prefix}_r2_max`).value);

                ranges_by_op[op] = [
                    [r1_min, r1_max],
                    [r2_min, r2_max]
                ];
            });

            const res = await fetch("/generate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    number_questions,
                    operations,
                    ranges_by_op,
                    decimals: [0, 0],
                    exact_division: true
                })
            });

            const data = await res.json();
            currentQuestions = data.questions;

            // Show questions
            questionList.innerHTML = "";
            currentQuestions.forEach((q, i) => {
                const div = document.createElement("div");
                div.className = "question";
                div.innerHTML = `
                    <div class="question-label">Question ${i + 1}:</div>
                    <div class="question-expression">${q.pretty || q.question}</div>
                    <input type="text" name="answer" data-index="${i}" class="answer-box">
                `;
                questionList.appendChild(div);
            });

            testContainer.classList.remove("hidden");
            resultsDiv.classList.add("hidden");
        });

        answerForm.addEventListener("submit", async function(event) {
            event.preventDefault();

            const answers = Array.from(answerForm.querySelectorAll('input[name="answer"]'))
                                 .map(input => input.value.trim());

            const res = await fetch("/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ answers })
            });

            const data = await res.json();

            resultsDiv.innerHTML = `
                <h2>Result</h2>
                <p>Score: ${data.score}</p>
                <p>Correct: ${data.correct} / ${data.total} (${data.accuracy}%)</p>
            `;

            resultsDiv.classList.remove("hidden");
        });
    </script>
</body>
</html>
